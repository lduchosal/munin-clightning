#!/bin/sh
# -*- sh -*-
# vim: ft=sh

: << =cut

=head1 NAME

lightningd_peers - Plugin to monitor your lightningd node

=head1 CONFIGURATION

 [lightningd_*]
    user bitcoin
    env.binary lightning-cli
    env.data_dir /var/db/c-lightning

=head1 AUTHOR

Luc Dvchosal

=head1 LICENSE

AGPLv3+

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf

=cut

BINARY=${binary:-"/usr/bin/lightning-cli"}
DATA_DIR=${data_dir:-"/var/db/c-lightning"}

if [ "$1" == "test" ] \
   || [ "$1" == "test2" ]; then
    echo 
    echo "# "
    echo "# $0 $1"
    echo "# "
    echo 
fi



if [ ! -f "$BINARY" ]; then
    echo $0 $BINARY not found
    BINARY=/bin/echo
fi


if [ "$1" = "autoconf" ]; then
    autoconf="yes"

    command -v $BINARY >/dev/null || autoconf="no"

    echo $autoconf
    exit 0
fi

listpeers=$($BINARY --lightning-dir=$DATA_DIR listpeers)

if [ "$1" = "test" ]; then

{
   "peers": [
      {
         "id": "039ecb633664d6fa8a58ee0ab5f11f38b0f0a0a34897e4c6fef4de691485c41407",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "u5gvoigtlkcukaas3zgjksvvwkz7ca7gj7uljh6h5kop3ahfkagiivqd.onion:9735"
         ],
         "features": "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008a8251a1"
      },
      {
         "id": "02faa433f03dec55f87a0184003813919f0936d2d67902a7bc9196592e52f9cbea",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "170.75.167.59:9735"
         ],
         "features": "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008a8a51a1"
      },
      {
         "id": "031f2669adab71548fad4432277a0d90233e3bc07ac29cfb0b3e01bd3fb26cb9fa",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "44.242.118.94:9735"
         ],
         "features": "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008a8a51a1"
      },
      {
         "id": "02109ab6b08d040364c660cc176ce54b1bbcb6c33c2fab3e26a63ec3b260927d72",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "180.131.125.105:9735"
         ],
         "features": "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008a8251a1"
      },
      {
         "id": "02109ab6b08d040364c660cc176ce54b1bbcb6c33c2fab3e26a63ec3b260927d72",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "180.131.125.105:9735"
         ],
         "features": "800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008a8251a1"
      },
      {
         "id": "03e2408a49f07d2f4083a47344138ef89e7617e63919202c92aa8d49b574a560ae",
         "connected": true,
         "num_channels": 0,
         "netaddr": [
            "65.108.246.14:19736"
         ],
         "remote_addr": "176.65.149.88:36094",
         "features": "08a0882a8a59a1"
      }
   ]
}
__EOF__
)

fi

if [ "$1" = "test2" ]; then

    listpeers=$(cat <<__EOF__
{
   "peers": []
}
__EOF__
)

fi


#
# transform
#

jsont=$(cat <<__EOF__
{
   "total": .peers | length,
   "peers": [ 
      .peers[] | {
         "id": .id,
         "label": .netaddr[0],
         "value": .num_channels
      }]

}
__EOF__
)

result=$(echo $listpeers | jq "$(echo $jsont)")
if [ "$1" = "debug" ]; then
    echo $listpeers | jq
    echo $result | jq
fi


#
# config
#

if [ "$1" = "config" ]; then

    echo 'graph_title lightningd peers info'
    echo 'graph_vlabel peers'
    echo 'graph_category lightningd'
    echo 'graph_info This graph shows the peers reported by lightningd.'

    echo 'total.label total sats'

    for item in $(echo $result | jq -c '.peers[]'); do
        id=$(echo $item | jq -r ".id")
        label=$(echo $item | jq -r ".label")
        value=$(echo $item | jq -r ".value * -1")
        sid=$(echo $id | sha1sum | cut -c1-8)
        echo "peer_$sid.label $label"
        echo "peer_$sid.draw AREASTACK"
    done

    exit 0
fi

echo "total.value $(echo $result | jq -r '.total')"

for item in $(echo $result | jq -c '.peers[]'); do
   id=$(echo $item | jq -r ".id")
   label=$(echo $item | jq -r ".label")
   value=$(echo $item | jq -r ".value")
   echo "peer_$(echo $id | sha1sum | cut -c1-8).value $value"
done
